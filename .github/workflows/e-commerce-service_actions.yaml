name: Service CI/CD Pipeline

on:
  push:
    branches: [22-msa-infra-ëª¨ë“ˆ-cicd-ì ìš©-ë°-cicd-ê°œì„ ]
    paths:
      - 'service/**'
      - 'common/**'
  pull_request:
    branches: [22-msa-infra-ëª¨ë“ˆ-cicd-ì ìš©-ë°-cicd-ê°œì„ ]
    paths:
      - 'service/**'
      - 'common/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: public.ecr.aws/o3q0p5x7
  ECS_CLUSTER: e-commerce

jobs:
  # âœ… 1ë‹¨ê³„: ì„œë¹„ìŠ¤ ìë™ ë°œê²¬ + ë³€ê²½ ê°ì§€
  discover-and-detect:
    runs-on: ubuntu-latest
    outputs:
      services-matrix: ${{ steps.generate-matrix.outputs.services-matrix }}
      changed-services: ${{ steps.detect-changes.outputs.changed-services }}
      common-changed: ${{ steps.detect-changes.outputs.common-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ” ì„œë¹„ìŠ¤ ìë™ ë°œê²¬
      - name: Discover services
        id: discover
        run: |
          echo "ğŸ” ì„œë¹„ìŠ¤ ë””ë ‰í„°ë¦¬ ìŠ¤ìº” ì¤‘..."
          
          # service/ ë””ë ‰í„°ë¦¬ì—ì„œ Dockerfileì´ ìˆëŠ” ì„œë¹„ìŠ¤ë§Œ ê°ì§€
          services=$(find service -maxdepth 1 -type d -exec test -f {}/Dockerfile \; -print | \
                    sed 's|service/||' | \
                    grep -v '^$' | \
                    sort | \
                    jq -R -s -c 'split("\n")[:-1]')
          
          echo "services=$services" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ë°œê²¬ëœ ì„œë¹„ìŠ¤: $services"
          
          # paths-filterë¥¼ ìœ„í•œ ë™ì  í•„í„° ìƒì„±
          filter_config="common:\n  - 'common/**'\n  - 'build.gradle.kts'\n  - 'settings.gradle.kts'\n"
          
          for service in $(echo $services | jq -r '.[]'); do
            filter_config="${filter_config}${service}:\n  - 'service/${service}/**'\n"
          done
          
          echo -e "$filter_config" > filters.yml
          echo "ğŸ”§ ë™ì  í•„í„° ìƒì„± ì™„ë£Œ:"
          cat filters.yml

      # ğŸ¯ ë³€ê²½ì‚¬í•­ ê°ì§€ (ë™ì  í•„í„° ì‚¬ìš©)
      - name: Detect changes
        id: detect-changes
        uses: dorny/paths-filter@v3
        with:
          filters: filters.yml
          list-files: shell

      # ğŸ“Š ë³€ê²½ëœ ì„œë¹„ìŠ¤ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
      - name: Generate services matrix
        id: generate-matrix
        run: |
          services='${{ steps.discover.outputs.services }}'
          common_changed='${{ steps.detect-changes.outputs.common }}'
          changed_services='[]'
          
          echo "ğŸ” ë³€ê²½ì‚¬í•­ ë¶„ì„ ì¤‘..."
          echo "ğŸ“‹ ì „ì²´ ì„œë¹„ìŠ¤: $services"
          echo "ğŸ“‹ ê³µí†µ ëª¨ë“ˆ ë³€ê²½: $common_changed"
          
          # ê° ì„œë¹„ìŠ¤ë³„ ë³€ê²½ì‚¬í•­ í™•ì¸
          for service in $(echo $services | jq -r '.[]'); do
            service_changed=$(echo '${{ steps.detect-changes.outputs }}' | jq -r ".${service}")
            echo "ğŸ“‹ $service ë³€ê²½: $service_changed"
          
            # ê³µí†µ ëª¨ë“ˆ ë³€ê²½ë˜ì—ˆê±°ë‚˜ í•´ë‹¹ ì„œë¹„ìŠ¤ê°€ ë³€ê²½ëœ ê²½ìš°
            if [[ "$common_changed" == "true" || "$service_changed" == "true" ]]; then
              changed_services=$(echo $changed_services | jq ". + [\"$service\"]")
              echo "âœ… $service ë°°í¬ ëŒ€ìƒì— ì¶”ê°€"
            else
              echo "â­ï¸ $service ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            fi
          done
          
          echo "services-matrix=$changed_services" >> $GITHUB_OUTPUT
          echo "changed-services=$changed_services" >> $GITHUB_OUTPUT
          echo "common-changed=$common_changed" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ìµœì¢… ë°°í¬ ëŒ€ìƒ: $changed_services"          


  # âœ… 2ë‹¨ê³„: ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ & í…ŒìŠ¤íŠ¸
  build-and-test:
    runs-on: ubuntu-latest
    needs: discover-and-detect
    if: needs.discover-and-detect.outputs.changed-services != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-and-detect.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Build and test service
        run: |
          echo "ğŸ”¨ Building ${{ matrix.service }} service..."
          chmod +x ./gradlew
          ./gradlew :service:${{ matrix.service }}:build :service:${{ matrix.service }}:test

      - name: Build Docker image
        run: |
          echo "ğŸ³ Building Docker image for ${{ matrix.service }}..."
          docker build -t $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} -f service/${{ matrix.service }}/Dockerfile .
          docker tag $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} $ECR_REGISTRY/${{ matrix.service }}:latest

  # âœ… 3ë‹¨ê³„: ë°°í¬ (ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ)
  deploy-services:
    runs-on: ubuntu-latest
    needs: [discover-and-detect, build-and-test]
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.build-and-test.result == 'success' &&
      needs.discover-and-detect.outputs.changed-services != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-and-detect.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ”§ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ë°°í¬ ì•¡ì…˜ í˜¸ì¶œ
      - name: Deploy service
        uses: ./.github/actions/aws-deploy
        with:
          service-name: ${{ matrix.service }}
          service-path: service/${{ matrix.service }}
          ecr-registry: ${{ env.ECR_REGISTRY }}
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ecs-cluster: ${{ env.ECS_CLUSTER }}
          gradle-task: :service:${{ matrix.service }}:build
          cleanup-old-images: 'true'
