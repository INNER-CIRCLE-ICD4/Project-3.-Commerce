name: Service CI/CD Pipeline

on:
  push:
    branches: [22-msa-infra-ëª¨ë“ˆ-cicd-ì ìš©-ë°-cicd-ê°œì„ ]
    paths:
      - 'service/**'
      - 'common/**'
  pull_request:
    branches: [22-msa-infra-ëª¨ë“ˆ-cicd-ì ìš©-ë°-cicd-ê°œì„ ]
    paths:
      - 'service/**'
      - 'common/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: public.ecr.aws/o3q0p5x7
  ECS_CLUSTER: e-commerce

jobs:
  # âœ… 1ë‹¨ê³„: ì„œë¹„ìŠ¤ ìë™ ë°œê²¬ + ë³€ê²½ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-services: ${{ steps.generate.outputs.changed-services }}
      common-changed: ${{ steps.filter.outputs.common }}
      order: ${{ steps.filter.outputs.order }}
      product: ${{ steps.filter.outputs.product }}
      review: ${{ steps.filter.outputs.review }}
      search: ${{ steps.filter.outputs.search }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ¯ ë³€ê²½ì‚¬í•­ ê°ì§€
      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            common:
              - 'common/**'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
            order:
              - 'service/order/**'
            product:
              - 'service/product/**'
            review:
              - 'service/review/**'
            search:
              - 'service/search/**'

      # ğŸ“Š ë³€ê²½ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ìƒì„±
      - name: Generate changed services list
        id: generate
        run: |
          echo "ğŸ” ë³€ê²½ì‚¬í•­ ë¶„ì„ ì¤‘..."
          changed_services='[]'
          
          common_changed='${{ steps.filter.outputs.common }}'
          echo "ğŸ“‹ ê³µí†µ ëª¨ë“ˆ ë³€ê²½: $common_changed"
          echo "ğŸ“‹ Order ë³€ê²½: ${{ steps.filter.outputs.order }}"
          echo "ğŸ“‹ Product ë³€ê²½: ${{ steps.filter.outputs.product }}"
          echo "ğŸ“‹ Review ë³€ê²½: ${{ steps.filter.outputs.review }}"
          echo "ğŸ“‹ Search ë³€ê²½: ${{ steps.filter.outputs.search }}"
          
          # ê° ì„œë¹„ìŠ¤ë³„ í™•ì¸
          if [[ "$common_changed" == "true" || "${{ steps.filter.outputs.order }}" == "true" ]]; then
            changed_services=$(echo $changed_services | jq '. + ["order"]')
            echo "âœ… order ë°°í¬ ëŒ€ìƒ"
          fi
          
          if [[ "$common_changed" == "true" || "${{ steps.filter.outputs.product }}" == "true" ]]; then
            changed_services=$(echo $changed_services | jq '. + ["product"]')
            echo "âœ… product ë°°í¬ ëŒ€ìƒ"
          fi
          
          if [[ "$common_changed" == "true" || "${{ steps.filter.outputs.review }}" == "true" ]]; then
            changed_services=$(echo $changed_services | jq '. + ["review"]')
            echo "âœ… review ë°°í¬ ëŒ€ìƒ"
          fi
          
          if [[ "$common_changed" == "true" || "${{ steps.filter.outputs.search }}" == "true" ]]; then
            changed_services=$(echo $changed_services | jq '. + ["search"]')
            echo "âœ… search ë°°í¬ ëŒ€ìƒ"
          fi
          
          echo "changed-services=$changed_services" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ìµœì¢… ë°°í¬ ëŒ€ìƒ: $changed_services"        


  # âœ… 2ë‹¨ê³„: ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ & í…ŒìŠ¤íŠ¸
  build-and-test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.discover-and-detect.outputs.changed-services != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Build and test service
        run: |
          echo "ğŸ”¨ Building ${{ matrix.service }} service..."
          chmod +x ./gradlew
          ./gradlew :service:${{ matrix.service }}:build :service:${{ matrix.service }}:test

      - name: Build Docker image
        run: |
          echo "ğŸ³ Building Docker image for ${{ matrix.service }}..."
          docker build -t $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} -f service/${{ matrix.service }}/Dockerfile .
          docker tag $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} $ECR_REGISTRY/${{ matrix.service }}:latest

  # âœ… 3ë‹¨ê³„: ë°°í¬ (ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ)
  deploy-services:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/22-msa-infra-ëª¨ë“ˆ-cicd-ì ìš©-ë°-cicd-ê°œì„ ' &&
      needs.build-and-test.result == 'success' &&
      needs.discover-and-detect.outputs.changed-services != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ”§ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ë°°í¬ ì•¡ì…˜ í˜¸ì¶œ
      - name: Deploy service
        uses: ./.github/actions/aws-deploy
        with:
          service-name: ${{ matrix.service }}
          service-path: service/${{ matrix.service }}
          ecr-registry: ${{ env.ECR_REGISTRY }}
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ecs-cluster: ${{ env.ECS_CLUSTER }}
          gradle-task: :service:${{ matrix.service }}:build
          cleanup-old-images: 'true'
