name: Infrastructure CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: public.ecr.aws/o3q0p5x7
  ECS_CLUSTER: e-commerce

jobs:
  detect-infra-changes:
    runs-on: ubuntu-latest
    outputs:
      common-changed: ${{ steps.filter.outputs.common }}
      config-server: ${{ steps.filter.outputs.config-server }}
      eureka-server: ${{ steps.filter.outputs.eureka-server }}
      gateway: ${{ steps.filter.outputs.gateway }}
      any-infra-changed: ${{ steps.check.outputs.any-changed }}
      changed-services: ${{ steps.generate-matrix.outputs.changed-services }}
      has-changes: ${{ steps.generate-matrix.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common: 
              - 'common/**'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
            config-server: 
              - 'infra/config-server/**'
            eureka-server:
              - 'infra/eureka-server/**'
            gateway: 
              - 'infra/gateway/**'

      - name: Generate changed services matrix
        id: generate-matrix
        run: |
          changed_services='[]'
          
          echo "ðŸ” ë³€ê²½ëœ ì„œë¹„ìŠ¤ í™•ì¸ ì¤‘..."
          
          # ðŸ”¥ ê³µí†µ ëª¨ë“ˆ ë³€ê²½ ì‹œ ëª¨ë“  ì¸í”„ë¼ ì„œë¹„ìŠ¤ í¬í•¨
          if [[ "${{ steps.filter.outputs.common }}" == "true" ]]; then
            # âœ… í•œ ì¤„ë¡œ ì••ì¶•ëœ JSON
            changed_services='[{"service":"config-server","priority":1,"port":9000},{"service":"eureka-server","priority":2,"port":8761},{"service":"gateway","priority":3,"port":8000}]'
            echo "ðŸ“‹ ê³µí†µ ëª¨ë“ˆ ë³€ê²½ - ëª¨ë“  ì¸í”„ë¼ ì„œë¹„ìŠ¤ ë°°í¬"
          else
            # ðŸ”¥ ê°œë³„ ì„œë¹„ìŠ¤ ë³€ê²½ í™•ì¸
            if [[ "${{ steps.filter.outputs.config-server }}" == "true" ]]; then
              changed_services=$(echo $changed_services | jq -c '. + [{"service":"config-server","priority":1,"port":9000}]')
              echo "âœ… config-server ë°°í¬ ëŒ€ìƒ"
            fi
          
            if [[ "${{ steps.filter.outputs.eureka-server }}" == "true" ]]; then
              changed_services=$(echo $changed_services | jq -c '. + [{"service":"eureka-server","priority":2,"port":8761}]')
              echo "âœ… eureka-server ë°°í¬ ëŒ€ìƒ"
            fi
          
            if [[ "${{ steps.filter.outputs.gateway }}" == "true" ]]; then
              changed_services=$(echo $changed_services | jq -c '. + [{"service":"gateway","priority":3,"port":8000}]')
              echo "âœ… gateway ë°°í¬ ëŒ€ìƒ"
            fi
          fi
          
          # ðŸ”¥ ë³€ê²½ì‚¬í•­ ì—¬ë¶€ í™•ì¸
          service_count=$(echo $changed_services | jq 'length')
          if [[ $service_count -gt 0 ]]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi
          
          # âœ… JSONì„ compact í˜•íƒœë¡œ ì¶œë ¥ (ì¤‘ìš”!)
          echo "changed-services=$(echo $changed_services | jq -c '.')" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ ìµœì¢… ë°°í¬ ëŒ€ìƒ ($service_countê°œ): $changed_services"

      - name: Check if any infra changed
        id: check
        run: |
          if [[ "${{ steps.generate-matrix.outputs.has-changes }}" == "true" ]]; then
            echo "any-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… ì¸í”„ë¼ ë³€ê²½ì‚¬í•­ ìžˆìŒ"
          else
            echo "any-changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ì¸í”„ë¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi

  cleanup-ecr-images:
    runs-on: ubuntu-latest
    needs: detect-infra-changes
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' && 
      needs.detect-infra-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        # ðŸ”¥ Dynamic Matrix - ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ í¬í•¨
        include: ${{ fromJson(needs.detect-infra-changes.outputs.changed-services) }}
    steps:
      - name: Configure AWS credentials (ECR)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public

      - name: Cleanup old Images
        run: |
          echo "ðŸ—‘ï¸ Cleaning up old images for ${{ matrix.service }}..."
          
          image_digests=$(aws ecr-public describe-images --repository-name "infra/${{ matrix.service }}" --query 'imageDetails[].imageDigest'  --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")
          
          if [ ! -z "$image_digests" ] && [ "$image_digests" != "" ]; then
            image_count=$(echo $image_digests | wc -w)
            echo "ðŸ” Found $image_count existing images to delete"
          
            for digest in $image_digests; do 
              if [ ! -z "$digest" ] && [ "$digest" != "None" ]; then
                echo "ðŸ—‘ï¸ Deleting image digest: $digest"
                aws ecr-public batch-delete-image --repository-name "infra/${{ matrix.service }}" --image-ids imageDigest=$digest --region ${{ env.AWS_REGION }} || echo "Failed to delete $digest"
              fi
            done
          
            echo "âœ… Successfully deleted all $image_count existing images from infra/${{ matrix.service }}"
          else
            echo "â„¹ï¸ No existing images found in infra/${{ matrix.service }} repository"
          fi

  build-infra:
    runs-on: ubuntu-latest
    needs: detect-infra-changes
    if: needs.detect-infra-changes.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        # ðŸ”¥ Dynamic Matrix - ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ í¬í•¨
        include: ${{ fromJson(needs.detect-infra-changes.outputs.changed-services) }}
    steps:
      # ðŸ”¥ Skip ë¡œì§ ì™„ì „ ì œê±° - Matrixì— ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ìžˆìŒ

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-infra-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-infra-

      - name: Build and test infra service
        run: |
          echo "ðŸ”¨ Building ${{ matrix.service }}..."
          echo "ðŸ“‹ Service Info: Priority=${{ matrix.priority }}, Port=${{ matrix.port }}"
          chmod +x ./gradlew
          ./gradlew :infra:${{ matrix.service }}:build :infra:${{ matrix.service }}:test

      - name: Build Docker Test
        run: |
          echo "ðŸ³ Building Docker image for ${{ matrix.service }}..."
          docker build -t $ECR_REGISTRY/infra/${{ matrix.service }}:${{ github.sha }} -f infra/${{ matrix.service }}/Dockerfile .
          docker tag $ECR_REGISTRY/infra/${{ matrix.service }}:${{ github.sha }} $ECR_REGISTRY/infra/${{ matrix.service }}:latest

  deploy-infra:
    runs-on: ubuntu-latest
    needs: [detect-infra-changes, build-infra]
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.build-infra.result == 'success' &&
      needs.detect-infra-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        # ðŸ”¥ Dynamic Matrix - ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ í¬í•¨
        include: ${{ fromJson(needs.detect-infra-changes.outputs.changed-services) }}
    steps:
      # ðŸ”¥ Skip ë¡œì§ ì™„ì „ ì œê±°

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Rebuild and Push Docker image
        run: |
          echo "ðŸ”„ Rebuilding ${{ matrix.service }}..."
          echo "ðŸ“‹ Service Info: Priority=${{ matrix.priority }}, Port=${{ matrix.port }}"
          chmod +x ./gradlew
          ./gradlew :infra:${{ matrix.service }}:build
          
          docker build -t $ECR_REGISTRY/infra/${{ matrix.service }}:${{ github.sha }} -f infra/${{ matrix.service }}/Dockerfile .
          docker tag $ECR_REGISTRY/infra/${{ matrix.service }}:${{ github.sha }} $ECR_REGISTRY/infra/${{ matrix.service }}:latest

      - name: Configure AWS credentials (ECR)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public

      - name: Push to ECR
        run: |
          echo "ðŸš€ Pushing ${{ matrix.service }} to ECR..."
          docker push $ECR_REGISTRY/infra/${{ matrix.service }}:${{ github.sha }}
          docker push $ECR_REGISTRY/infra/${{ matrix.service }}:latest

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Update Task Definition and Deploy to ECS
        run: |
          echo "ðŸ”„ ${{ matrix.service }} Task Definition ì—…ë°ì´íŠ¸ ë° ECS ë°°í¬ ì¤‘..."
          echo "ðŸ“‹ Deploy Priority: ${{ matrix.priority }}"

          # ê¸°ì¡´ Task Definition ê°€ì ¸ì˜¤ê¸°
          aws ecs describe-task-definition \
            --task-definition ${{ matrix.service }} \
            --query 'taskDefinition' \
            --output json > temp-${{ matrix.service }}.json

          # jqë¡œ ì•ˆì „í•˜ê²Œ í•„ë“œ ì œê±° ë° ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
          jq --arg image "${{ env.ECR_REGISTRY }}/infra/${{ matrix.service }}:latest" '
            del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy) |
            .containerDefinitions[0].image = $image
          ' temp-${{ matrix.service }}.json > clean-${{ matrix.service }}.json

          # Task Definition ë“±ë¡
          aws ecs register-task-definition \
            --cli-input-json file://clean-${{ matrix.service }}.json

          # ì„œë¹„ìŠ¤ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
          echo "ðŸ” ì„œë¹„ìŠ¤ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."
          if aws ecs describe-services \
          --cluster e-commerce \
          --services ${{ matrix.service }}-service \
          --query 'services[0].status' \
          --output text 2>/dev/null | grep -q "ACTIVE"; then
          
          echo "âœ… ì„œë¹„ìŠ¤ ${{ matrix.service }}-service ì¡´ìž¬ - ì—…ë°ì´íŠ¸ ì§„í–‰"
          aws ecs update-service \
          --cluster e-commerce \
          --service ${{ matrix.service }}-service \
          --task-definition ${{ matrix.service }} \
          --force-new-deployment
          echo "ðŸŽ‰ ${{ matrix.service }} ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          
          else
          echo "âš ï¸ ì„œë¹„ìŠ¤ ${{ matrix.service }}-serviceê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "ðŸ“‹ Task Definition '${{ matrix.service }}'ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ðŸ”§ ë‹¤ìŒ ë‹¨ê³„: AWS ì½˜ì†”ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”."
          echo "   - í´ëŸ¬ìŠ¤í„°: e-commerce"
          echo "   - ì„œë¹„ìŠ¤ ì´ë¦„: ${{ matrix.service }}-service"
          echo "   - Task Definition: ${{ matrix.service }}:latest"
          echo "   - í¬íŠ¸: ${{ matrix.port }}"
          fi

          # ìž„ì‹œ íŒŒì¼ ì‚­ì œ
          rm temp-${{ matrix.service }}.json clean-${{ matrix.service }}.json  

          echo "ðŸŽ‰ ${{ matrix.service }} ë°°í¬ ì‹œìž‘ ì™„ë£Œ!"

  # ðŸ”¥ ê°œì„ ëœ Pipeline Summary
  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [detect-infra-changes, build-infra, deploy-infra]
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "## ðŸš€ Infrastructure CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ðŸ”¥ ë³€ê²½ëœ ì„œë¹„ìŠ¤ ì •ë³´ ì¶œë ¥
          changed_services='${{ needs.detect-infra-changes.outputs.changed-services }}'
          echo "### ðŸ“‹ Changed Services" >> $GITHUB_STEP_SUMMARY
          if [[ "$changed_services" == "[]" ]]; then
            echo "â„¹ï¸ No infrastructure changes detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Service | Priority | Port | Build Status | Deploy Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|----------|------|--------------|---------------|" >> $GITHUB_STEP_SUMMARY
          
            # JSON íŒŒì‹±í•´ì„œ ê° ì„œë¹„ìŠ¤ë³„ ìƒíƒœ ì¶œë ¥
            echo "$changed_services" | jq -r '.[] | "| \(.service) | \(.priority) | \(.port) | ${{ needs.build-infra.result == 'success' && 'âœ… ì„±ê³µ' || needs.build-infra.result == 'failure' && 'âŒ ì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.deploy-infra.result == 'success' && 'ðŸš€ ì™„ë£Œ' || needs.deploy-infra.result == 'failure' && 'ðŸ’¥ ì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} |"' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Pipeline Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Changes**: ${{ needs.detect-infra-changes.outputs.has-changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Common Changed**: ${{ needs.detect-infra-changes.outputs.common-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Push to ECR**: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY