name: Multi-Module CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# AWS ì„¤ì • ì •ë³´
env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: public.ecr.aws/o3q0p5x7

# 1ë‹¨ê³„: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
      common-changed: ${{ steps.filter.outputs.common }}
      order: ${{ steps.filter.outputs.order }}
      product: ${{ steps.filter.outputs.product }}
      review: ${{ steps.filter.outputs.review }}
      search: ${{ steps.filter.outputs.search }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common:
              - 'common/**'
            order:
              - 'service/order/**'
            product:
              - 'service/product/**'
            review:
              - 'service/review/**'
            search:
              - 'service/search/**'

  # 2ë‹¨ê³„: ë³€ê²½ëœ ì„œë¹„ìŠ¤ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
  prepare-matrix:
    runs-on: ubuntu-latest
    needs: detect-changes
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Set matrix for changed services
        id: set-matrix
        env:
          COMMON_CHANGED: ${{ needs.detect-changes.outputs.common-changed }}
          ORDER_CHANGED: ${{ needs.detect-changes.outputs.order }}
          PRODUCT_CHANGED: ${{ needs.detect-changes.outputs.product }}
          REVIEW_CHANGED: ${{ needs.detect-changes.outputs.review }}
          SEARCH_CHANGED: ${{ needs.detect-changes.outputs.search }}
        run: |
          services=()
          
          if [ "$COMMON_CHANGED" = "true" ]; then
            services=("order" "product" "review" "search")
            echo "ðŸ”„ Common ëª¨ë“ˆ ë³€ê²½ë¨ - ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ"
          else
            # ê°œë³„ ì„œë¹„ìŠ¤ ë³€ê²½ í™•ì¸
            [ "$ORDER_CHANGED" = "true" ] && services+=("order")
            [ "$PRODUCT_CHANGED" = "true" ] && services+=("product")
            [ "$REVIEW_CHANGED" = "true" ] && services+=("review")
            [ "$SEARCH_CHANGED" = "true" ] && services+=("search")
          fi
          
          # JSON ë°°ì—´ë¡œ ë³€í™˜
          if [ ${#services[@]} -eq 0 ]; then
            matrix_json='{"service":[]}'
            has_changes="false"
            echo "âš ï¸ ë³€ê²½ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤"
          else
            matrix_json=$(printf '%s\n' "${services[@]}" | jq -R . | jq -s -c '{service: .}')
            has_changes="true"
            echo "ðŸš€ ë³€ê²½ëœ ì„œë¹„ìŠ¤: ${services[*]}"
          fi
          
          echo "matrix=${matrix_json}" >> $GITHUB_OUTPUT
          echo "has-changes=${has_changes}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Matrix JSON: ${matrix_json}"

  # 3ë‹¨ê³„: ì„œë¹„ìŠ¤ë³„ ë³‘ë ¬ ë¹Œë“œ (ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ)
  build-services:
    runs-on: ubuntu-latest
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build and test service
        run: |
          echo "ðŸ”¨ Building ${{ matrix.service }} service..."
          chmod +x ./gradlew
          ./gradlew :service:${{ matrix.service }}:build :service:${{ matrix.service }}:test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        id: login-ecr-public
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public

      - name: Create ECR Repository if not exists
        run: |
          aws ecr-public describe-repositories --repository-names ${{ matrix.service }} --region ${{ env.AWS_REGION }} || \
          aws ecr-public create-repository --repository-name ${{ matrix.service }} --region ${{ env.AWS_REGION }}

      - name: Build Docker image
        run: | 
          echo "ðŸ³ Building Docker image for ${{ matrix.service }}..."
          docker build -t $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} -f service/${{ matrix.service }}/Dockerfile .
          docker tag $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} $ECR_REGISTRY/${{ matrix.service }}:latest

      - name: Push to ECR Public
        run: | 
          echo "ðŸš€ Pushing images for ${{ matrix.service }}..."
          docker push $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }}
          docker push $ECR_REGISTRY/${{ matrix.service }}:latest
          echo "âœ… ${{ matrix.service }} ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ!"

  # 4ë‹¨ê³„: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
  build-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, prepare-matrix, build-services]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Multi-Module CI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Order | ${{ needs.detect-changes.outputs.order == 'true' && 'built' || 'skipped' }} | ${{ needs.detect-changes.outputs.order }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Product | ${{ needs.detect-changes.outputs.product == 'true' && 'built' || 'skipped' }} | ${{ needs.detect-changes.outputs.product }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Review | ${{ needs.detect-changes.outputs.review == 'true' && 'built' || 'skipped' }} | ${{ needs.detect-changes.outputs.review }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Search | ${{ needs.detect-changes.outputs.search == 'true' && 'built' || 'skipped' }} | ${{ needs.detect-changes.outputs.search }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Common Changed**: ${{ needs.detect-changes.outputs.common-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Built Services**: ${{ needs.prepare-matrix.outputs.matrix }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Changes**: ${{ needs.prepare-matrix.outputs.has-changes }}" >> $GITHUB_STEP_SUMMARY