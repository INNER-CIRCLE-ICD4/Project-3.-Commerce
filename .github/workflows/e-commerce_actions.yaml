name: Multi-Module CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, 10-chore-commerce-cicd]

# AWS ì„¤ì • ì •ë³´
env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: public.ecr.aws/o3q0p5x7
  ECS_CLUSTER: e-commerce

# 1ë‹¨ê³„: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
      common-changed: ${{ steps.filter.outputs.common }}
      order: ${{ steps.filter.outputs.order }}
      product: ${{ steps.filter.outputs.product }}
      review: ${{ steps.filter.outputs.review }}
      search: ${{ steps.filter.outputs.search }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common:
              - 'common/**'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
            order:
              - 'service/order/**'
            product:
              - 'service/product/**'
            review:
              - 'service/review/**'
            search:
              - 'service/search/**'
          list-files: shell
      - name: Debug Outputs
        run: |
          echo "Common Changed: ${{ steps.filter.outputs.common }}"
          echo "Order Changed: ${{ steps.filter.outputs.order }}"
          echo "Product Changed: ${{ steps.filter.outputs.product }}"
          echo "Review Changed: ${{ steps.filter.outputs.review }}"
          echo "Search Changed: ${{ steps.filter.outputs.search }}"


  # 2ë‹¨ê³„: ì„œë¹„ìŠ¤ë³„ ë³‘ë ¬ ë¹Œë“œ
  build-and-test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.common-changed == 'true' || (needs.detect-changes.outputs.order == 'true' || needs.detect-changes.outputs.product == 'true' || needs.detect-changes.outputs.review == 'true' || needs.detect-changes.outputs.search == 'true')
    strategy:
      fail-fast: false
      matrix:
        service: [order, product, review, search]  # ë‹¨ìˆœí™”
    steps:
      - name: Skip if no changes
        if: |
          (matrix.service == 'order' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.order != 'true') ||
          (matrix.service == 'product' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.product != 'true') ||
          (matrix.service == 'review' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.review != 'true') ||
          (matrix.service == 'search' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.search != 'true')
        run: |
          echo "No changes detected for ${{ matrix.service }}, skipping..."
          exit 0

      - name: Checkout code
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: actions/checkout@v4

      - name: Set up JDK 21
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build and test service
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        run: |
          echo "ðŸ”¨ Building ${{ matrix.service }} service..."
          chmod +x ./gradlew
          ./gradlew :service:${{ matrix.service }}:build :service:${{ matrix.service }}:test

      - name: Build Docker image
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        run: | 
          echo "ðŸ³ Building Docker image for ${{ matrix.service }}..."
          docker build -t $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} -f service/${{ matrix.service }}/Dockerfile .
          docker tag $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} $ECR_REGISTRY/${{ matrix.service }}:latest

  # 3ë‹¨ê³„ ì´ë¯¸ì§€ push ë° ë§¤í¬
  #github.event_name == 'push' &&
  #github.ref == 'refs/heads/main' &&
  #needs.build-and-test.result == 'success' &&
  push-to-ecr:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: |
      (needs.detect-changes.outputs.common-changed == 'true' || 
       needs.detect-changes.outputs.order == 'true' || 
       needs.detect-changes.outputs.product == 'true' || 
       needs.detect-changes.outputs.review == 'true' || 
       needs.detect-changes.outputs.search == 'true')
    strategy:
      fail-fast: false
      matrix:
        service: [order, product, review, search]
    steps:
      # ðŸ†• í•­ìƒ ë¨¼ì € ì‹¤í–‰ë˜ëŠ” checkout
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Skip if no changes
        if: |
          (matrix.service == 'order' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.order != 'true') ||
          (matrix.service == 'product' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.product != 'true') ||
          (matrix.service == 'review' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.review != 'true') ||
          (matrix.service == 'search' && needs.detect-changes.outputs.common-changed != 'true' && needs.detect-changes.outputs.search != 'true')
        run: |
          echo "No changes detected for ${{ matrix.service }}, skipping push..."
          exit 0

      - name: Set up JDK 21
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Rebuild Docker image
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        run: |
          
          echo "ðŸ”„ Rebuilding Docker image for push..."
          
          echo "ðŸ”¨ Building ${{ matrix.service }} service..."
          chmod +x ./gradlew
          ./gradlew :service:${{ matrix.service }}:build :service:${{ matrix.service }}:test
        
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} -f service/${{ matrix.service }}/Dockerfile .
          docker tag $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }} $ECR_REGISTRY/${{ matrix.service }}:latest

      - name: Configure AWS credentials
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public

      - name: Create ECR Repository if not exists
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        run: |
          aws ecr-public describe-repositories --repository-names ${{ matrix.service }} --region ${{ env.AWS_REGION }} || \
          aws ecr-public create-repository --repository-name ${{ matrix.service }} --region ${{ env.AWS_REGION }}

      - name: Push to ECR Public
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        run: |
          echo "ðŸš€ Pushing images for ${{ matrix.service }}..."
          docker push $ECR_REGISTRY/${{ matrix.service }}:${{ github.sha }}
          docker push $ECR_REGISTRY/${{ matrix.service }}:latest
          echo "âœ… ${{ matrix.service }} ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ!"

      - name: Configure AWS credentials
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Update Task Definition and Deploy to ECS
        if: |
          (matrix.service == 'order' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.order == 'true')) ||
          (matrix.service == 'product' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.product == 'true')) ||
          (matrix.service == 'review' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.review == 'true')) ||
          (matrix.service == 'search' && (needs.detect-changes.outputs.common-changed == 'true' || needs.detect-changes.outputs.search == 'true'))
        run: |
          echo "ðŸ”„ ${{ matrix.service }} Task Definition ì—…ë°ì´íŠ¸ ë° ECS ë°°í¬ ì¤‘..."
          
          # ê¸°ì¡´ Task Definition ê°€ì ¸ì˜¤ê¸°
          aws ecs describe-task-definition \
            --task-definition ${{ matrix.service }} \
            --query 'taskDefinition' \
            --output json > temp-${{ matrix.service }}.json
          
          # Task Definitionì—ì„œ ì´ë¯¸ì§€ URL ì—…ë°ì´íŠ¸
          sed -i 's|"image": ".*"|"image": "${{ env.ECR_REGISTRY }}/${{ matrix.service }}:latest"|' \
            temp-${{ matrix.service }}.json
          
          # ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±° (ì™„ì „í•œ ëª©ë¡)
          cat temp-${{ matrix.service }}.json | \
            sed 's/"taskDefinitionArn":[^,]*,//g' | \
            sed 's/"revision":[^,]*,//g' | \
            sed 's/"status":[^,]*,//g' | \
            sed 's/"requiresAttributes":\[[^]]*\],//g' | \
            sed 's/"placementConstraints":\[[^]]*\],//g' | \
            sed 's/"compatibilities":\[[^]]*\],//g' | \
            sed 's/"registeredAt":[^,]*,//g' | \
            sed 's/"registeredBy":[^,]*,//g' > clean-${{ matrix.service }}.json
          
          # Task Definition ë“±ë¡
          aws ecs register-task-definition \
            --cli-input-json file://clean-${{ matrix.service }}.json
          
          # ìž„ì‹œ íŒŒì¼ ì‚­ì œ
               rm temp-${{ matrix.service }}.json clean-${{ matrix.service }}.json          
    
            
          # ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
          aws ecs update-service \
            --cluster e-commerce \
            --service ${{ matrix.service }}-service \
            --task-definition ${{ matrix.service }} \
            --force-new-deployment
          
          echo "ðŸŽ‰ ${{ matrix.service }} ë°°í¬ ì‹œìž‘ ì™„ë£Œ!"
      

  # 4ë‹¨ê³„: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test, push-to-ecr]
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "## ðŸš€ Multi-Module CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Build & Test | ECR Push | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------------|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Order | ${{ needs.build-and-test.result == 'success' && 'âœ… ì„±ê³µ' || needs.build-and-test.result == 'failure' && 'âŒ ì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.push-to-ecr.result == 'success' && 'ðŸš€ í‘¸ì‹œì™„ë£Œ' || needs.push-to-ecr.result == 'failure' && 'ðŸ’¥ í‘¸ì‹œì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.detect-changes.outputs.order }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Product | ${{ needs.build-and-test.result == 'success' && 'âœ… ì„±ê³µ' || needs.build-and-test.result == 'failure' && 'âŒ ì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.push-to-ecr.result == 'success' && 'ðŸš€ í‘¸ì‹œì™„ë£Œ' || needs.push-to-ecr.result == 'failure' && 'ðŸ’¥ í‘¸ì‹œì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.detect-changes.outputs.product }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Review | ${{ needs.build-and-test.result == 'success' && 'âœ… ì„±ê³µ' || needs.build-and-test.result == 'failure' && 'âŒ ì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.push-to-ecr.result == 'success' && 'ðŸš€ í‘¸ì‹œì™„ë£Œ' || needs.push-to-ecr.result == 'failure' && 'ðŸ’¥ í‘¸ì‹œì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.detect-changes.outputs.review }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Search | ${{ needs.build-and-test.result == 'success' && 'âœ… ì„±ê³µ' || needs.build-and-test.result == 'failure' && 'âŒ ì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.push-to-ecr.result == 'success' && 'ðŸš€ í‘¸ì‹œì™„ë£Œ' || needs.push-to-ecr.result == 'failure' && 'ðŸ’¥ í‘¸ì‹œì‹¤íŒ¨' || 'â­ï¸ ê±´ë„ˆëœ€' }} | ${{ needs.detect-changes.outputs.search }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Pipeline Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Common Changed**: ${{ needs.detect-changes.outputs.common-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ECR Push Condition**: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'âœ… Met' || 'âŒ Not Met' }}" >> $GITHUB_STEP_SUMMARY