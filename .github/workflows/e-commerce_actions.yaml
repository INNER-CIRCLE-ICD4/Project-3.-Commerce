name: Multi-Module CI/CD Pipeline

on:
  push:
    branches: [10-chore-commerce-cicd]
  pull_request:
    branches: [main]

# 1ë‹¨ê³„: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
      common-changed: ${{ steps.filter.outputs.common }}
      order: ${{ steps.filter.outputs.order }}
      product: ${{ steps.filter.outputs.product }}
      review: ${{ steps.filter.outputs.review }}
      search: ${{ steps.filter.outputs.search }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            common:
              - 'common/**'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
            order:
              - 'service/order/**'
              - 'common/**'
            product:
              - 'service/product/**'
              - 'common/**'
            review:
              - 'service/review/**'
              - 'common/**'
            search:
              - 'service/search/**'
              - 'common/**'

  # 2ë‹¨ê³„: ê³µí†µ ëª¨ë“ˆ ë¹Œë“œ
  build-common:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.common-changed == 'true'
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build common module
        run: |
          chmod +x ./gradlew
          ./gradlew :common:snowflake:build :common:snowflake:test

      - name: Upload common artifacts
        uses: actions/upload-artifact@v3
        with:
          name: common-artifacts
          path: common/snowflake/build/libs/

  # 3ë‹¨ê³„: ì„œë¹„ìŠ¤ë³„ ë³‘ë ¬ ë¹Œë“œ
  build-services:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-common]
    if: always() && !cancelled() && (needs.detect-changes.outputs.order == 'true' || needs.detect-changes.outputs.product == 'true' || needs.detect-changes.outputs.review == 'true' || needs.detect-changes.outputs.search == 'true')
    strategy:
      fail-fast: false  # í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ëŠ” ê³„ì† ì‹¤í–‰
      matrix:
        include:
          - service: order
            condition: ${{ needs.detect-changes.outputs.order == 'true' }}
          - service: product
            condition: ${{ needs.detect-changes.outputs.product == 'true' }}
          - service: review
            condition: ${{ needs.detect-changes.outputs.review == 'true' }}
          - service: search
            condition: ${{ needs.detect-changes.outputs.search == 'true' }}
    steps:
      - name: Skip if no changes
        if:  matrix.condition == 'false'
        run: echo "No changes detected for ${{ matrix.service }}, skipping..."

      - name: Checkout code
        if: matrix.condition == 'true'
        uses: actions/checkout@v3

      - name: Set up JDK 21
        if: matrix.condition == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        if: matrix.condition == 'true'
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Download common artifacts
        if: matrix.condition == 'true' && needs.build-common.result == 'success'
        uses: actions/download-artifact@v3
        with:
          name: common-artifacts
          path: common/snowflake/build/libs/

      - name: Build and test service
        if: matrix.condition == 'true'
        run: |
          chmod +x ./gradlew
          ./gradlew :service:${{ matrix.service }}:build :service:${{ matrix.service }}:test

  # 4ë‹¨ê³„: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
  build-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-services]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Multi-Module CI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Order | ${{ needs.build-services.result }} | ${{ needs.detect-changes.outputs.order }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Product | ${{ needs.build-services.result }} | ${{ needs.detect-changes.outputs.product }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Review | ${{ needs.build-services.result }} | ${{ needs.detect-changes.outputs.review }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Search | ${{ needs.build-services.result }} | ${{ needs.detect-changes.outputs.search }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY