# .github/actions/aws-deploy/action.yml
name: 'AWS ECR & ECS Deploy'
description: 'Reusable AWS deployment action for microservices'

inputs:
  service-name:
    description: 'Service name'
    required: true
  service-path:
    description: 'Service path (e.g., service/order, infra/config-server)'
    required: true
  ecr-registry:
    description: 'ECR registry URL'
    required: true
  aws-region:
    description: 'AWS region'
    required: true
  aws-access-key:
    description: 'AWS access key'
    required: true
  aws-secret-key:
    description: 'AWS secret key'
    required: true
  ecs-cluster:
    description: 'ECS cluster name'
    required: true
    default: 'e-commerce'
  cleanup-old-images:
    description: 'Whether to cleanup old ECR images'
    required: false
    default: 'true'
  gradle-task:
    description: 'Gradle build task'
    required: false
    default: 'build'

runs:
  using: 'composite'
  steps:
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ inputs.aws-access-key }}
        aws-secret-access-key: ${{ inputs.aws-secret-key }}
        aws-region: ${{ inputs.aws-region }}

    - name: Login to Amazon ECR Public
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registry-type: public

    # ğŸ—‘ï¸ ê¸°ì¡´ ì´ë¯¸ì§€ ì •ë¦¬ (ì˜µì…˜)
    - name: Cleanup old ECR images
      if: inputs.cleanup-old-images == 'true'
      shell: bash
      run: |
        echo "ğŸ—‘ï¸ Cleaning up old images for ${{ inputs.service-name }}..."
        
        # ECR ë ˆí¬ì§€í† ë¦¬ ì´ë¦„ ì„¤ì •
        if [[ "${{ inputs.service-path }}" == infra/* ]]; then
          repo_name="infra/${{ inputs.service-name }}"
        else
          repo_name="${{ inputs.service-name }}"
        fi
        
        echo "ğŸ“‹ Repository: $repo_name"
        
        image_digests=$(aws ecr-public describe-images --repository-name "$repo_name" --query 'imageDetails[].imageDigest' --output text --region ${{ inputs.aws-region }} 2>/dev/null || echo "")
        
        if [ ! -z "$image_digests" ] && [ "$image_digests" != "" ]; then
          image_count=$(echo $image_digests | wc -w)
          echo "ğŸ” Found $image_count existing images to delete"
        
          for digest in $image_digests; do 
            if [ ! -z "$digest" ] && [ "$digest" != "None" ]; then
              echo "ğŸ—‘ï¸ Deleting image: $digest"
              aws ecr-public batch-delete-image --repository-name "$repo_name" --image-ids imageDigest=$digest --region ${{ inputs.aws-region }} || echo "âš ï¸ Failed to delete $digest"
            fi
          done
        
          echo "âœ… Successfully deleted all $image_count existing images"
        else
          echo "â„¹ï¸ No existing images found in $repo_name"
        fi

    # ğŸ”¨ Gradle ë¹Œë“œ
    - name: Build with Gradle
      shell: bash
      run: |
        echo "ğŸ”¨ Building ${{ inputs.service-name }} with Gradle..."
        chmod +x ./gradlew
        ./gradlew ${{ inputs.gradle-task }}

    # ğŸ³ Docker ë¹Œë“œ & íƒœê¹…
    - name: Build and tag Docker image
      shell: bash
      run: |
        echo "ğŸ³ Building Docker image for ${{ inputs.service-name }}..."
        
        # ECR ë ˆí¬ì§€í† ë¦¬ ì´ë¦„ê³¼ ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì •
        if [[ "${{ inputs.service-path }}" == infra/* ]]; then
          image_name="${{ inputs.ecr-registry }}/infra/${{ inputs.service-name }}"
        else
          image_name="${{ inputs.ecr-registry }}/${{ inputs.service-name }}"
        fi
        
        echo "ğŸ“‹ Image name: $image_name"
        
        # Docker ë¹Œë“œ
        docker build -t $image_name:${{ github.sha }} -f ${{ inputs.service-path }}/Dockerfile .
        docker tag $image_name:${{ github.sha }} $image_name:latest
        
        echo "âœ… Docker image built and tagged"

#    # ğŸ“¦ ECR ë ˆí¬ì§€í† ë¦¬ ìƒì„± (í•„ìš”ì‹œ)
#    - name: Create ECR repository if not exists
#      shell: bash
#      run: |
#        if [[ "${{ inputs.service-path }}" == infra/* ]]; then
#          repo_name="infra/${{ inputs.service-name }}"
#        else
#          repo_name="${{ inputs.service-name }}"
#        fi
#
#        echo "ğŸ” Checking if repository $repo_name exists..."
#        aws ecr-public describe-repositories --repository-names "$repo_name" --region ${{ inputs.aws-region }} || \
#        aws ecr-public create-repository --repository-name "$repo_name" --region ${{ inputs.aws-region }}

    # ğŸš€ ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
    - name: Push to ECR
      shell: bash
      run: |
        if [[ "${{ inputs.service-path }}" == infra/* ]]; then
          image_name="${{ inputs.ecr-registry }}/infra/${{ inputs.service-name }}"
        else
          image_name="${{ inputs.ecr-registry }}/${{ inputs.service-name }}"
        fi
        
        echo "ğŸš€ Pushing images to ECR..."
        docker push $image_name:${{ github.sha }}
        docker push $image_name:latest
        echo "âœ… Images pushed successfully!"

    # ğŸ¯ ECS ë°°í¬ (Seoul ë¦¬ì „)
    - name: Deploy to ECS
      shell: bash
      run: |
        echo "ğŸ¯ Deploying ${{ inputs.service-name }} to ECS..."
        
        # Seoul ë¦¬ì „ìœ¼ë¡œ ë³€ê²½
        aws configure set region ap-northeast-2
        
        # ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì •
        if [[ "${{ inputs.service-path }}" == infra/* ]]; then
          image_name="${{ inputs.ecr-registry }}/infra/${{ inputs.service-name }}"
        else
          image_name="${{ inputs.ecr-registry }}/${{ inputs.service-name }}"
        fi
        
        # Task Definition ì—…ë°ì´íŠ¸
        aws ecs describe-task-definition \
          --task-definition ${{ inputs.service-name }} \
          --query 'taskDefinition' \
          --output json > temp-${{ inputs.service-name }}.json
        
        jq --arg image "$image_name:latest" '
          del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy) |
          .containerDefinitions[0].image = $image
        ' temp-${{ inputs.service-name }}.json > clean-${{ inputs.service-name }}.json
        
        aws ecs register-task-definition \
          --cli-input-json file://clean-${{ inputs.service-name }}.json
        
        # ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
        if aws ecs describe-services \
           --cluster ${{ inputs.ecs-cluster }} \
           --services ${{ inputs.service-name }}-service \
           --query 'services[0].status' \
           --output text 2>/dev/null | grep -q "ACTIVE"; then
        
          echo "âœ… ì„œë¹„ìŠ¤ ì¡´ì¬ - ì—…ë°ì´íŠ¸ ì§„í–‰"
          aws ecs update-service \
            --cluster ${{ inputs.ecs-cluster }} \
            --service ${{ inputs.service-name }}-service \
            --task-definition ${{ inputs.service-name }} \
            --force-new-deployment
          echo "ğŸ‰ ${{ inputs.service-name }} ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
        else
          echo "âš ï¸ ì„œë¹„ìŠ¤ ${{ inputs.service-name }}-serviceê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "ğŸ“‹ Task Definition '${{ inputs.service-name }}'ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
        fi
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f temp-${{ inputs.service-name }}.json clean-${{ inputs.service-name }}.json
        
        echo "ğŸ‰ ${{ inputs.service-name }} ë°°í¬ ì™„ë£Œ!"